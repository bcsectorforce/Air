<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BC air trafic control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{
 --bg:#0b1320;--panel:#121b2d;--radar:#06101c;
 --accent:#f0b429;--text:#d7e0ea;--muted:#8fa3bf;
 --danger:#ff4d4d;--warn:#ffae42;--safe:#4cff9f
}

/* === ADDITION #11: NIGHT MODE VARIABLES (ADDITIVE) === */
body.night{
 --bg:#03060f;
 --panel:#070b18;
 --radar:#000000;
 --text:#a9bbff;
 --accent:#6fa8ff;
}

body.night #radarWrap {
  filter: brightness(0.7) contrast(1.15) saturate(0.8);
}


*{box-sizing:border-box;font-family:Segoe UI,system-ui}
body{margin:0;background:var(--bg);color:var(--text);overflow:hidden}
#layout{display:grid;grid-template-columns:200px 1fr;height:100vh}

/* LEFT PANEL */
#panel{background:var(--panel);border-right:1px solid #1c2a44;padding:10px;overflow:auto}
h2{margin:0;color:var(--accent);font-size:15px}
#score{margin:6px 0;font-size:13px;color:var(--safe)}
.strip{background:#0e1627;border:1px solid #1e2c4a;padding:6px;margin:6px 0;cursor:pointer}
.strip.active{outline:2px solid var(--accent)}
.strip.warnFuel{border-color:var(--warn)}
.strip.dangerFuel{border-color:var(--danger)}
.strip.emergency{outline:2px solid var(--danger)}

.meta{font-size:12px;color:var(--muted)}
.controls button{
 margin:4px 2px;padding:5px 8px;font-size:11px;
 background:#1c2a44;color:var(--text);border:1px solid #243a63;cursor:pointer
}
.controls button:hover{border-color:var(--accent)}

/* RADAR */
#radarWrap {
  position: relative;

  /* MAP BACKGROUND */
  background-image:
    radial-gradient(circle, rgba(11,28,51,0.6), rgba(4,8,18,0.9)),
    url("https://eoimages.gsfc.nasa.gov/images/imagerecords/73000/73909/world.topo.bathy.200412.3x21600x10800.jpg");

  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;

  width: 100%;
  height: 100vh;

  touch-action: none;
  -ms-touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}


#radar {
  width: 100%;
  height: 100%;
}

.grid line{stroke:#0f1f38}
.sector{fill:none;stroke:#1c2a44;stroke-width:2}
.plane{
  font-size:20px;
  fill:#f0b429;
  cursor: pointer;
  pointer-events: all; /* ‚Üê THIS FIXES IT */
}

.route{fill:none;stroke:#5fa8ff;stroke-dasharray:4 4;stroke-width:2;opacity:1;transition:opacity 0.2s}
.warn{stroke:var(--warn)!important}
.danger{stroke:var(--danger)!important}
.weather{fill:rgba(255,174,66,.15);stroke:#ffae42;stroke-dasharray:5 5}

/* RADAR SWEEP */
.sweep{stroke:var(--accent);stroke-width:2;stroke-linecap:round}

/* POPUPS */
.popup{
 position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
 background:#0e1627;border:2px solid var(--accent);
 padding:18px;display:none;z-index:10;width:320px
}
.popup h3{margin-top:0;color:var(--accent)}

.planeLabel {
 font-size:12px;
 font-weight:600;
 fill:#ffffff;
 pointer-events:none;
 transition:opacity 0.2s;
}

@media (max-width: 600px){
  #layout { grid-template-columns: 200px 1fr; }
  .plane { font-size: 14px; fill:#ffffff }
  .planeLabel { font-size: 10px; }
  .controls button { font-size: 9px; padding:4px 6px; }
}
</style>
</head>

<body>
  
  <button onclick="toggleRun()">‚èØ Pause/Resume</button>

  
  <audio id="ping" src="https://freesound.org/data/previews/341/341695_6242284-lq.mp3"></audio>
<audio id="warnBeep" src="https://www.orangefreesounds.com/wp-content/uploads/2014/11/Beep-short.m3"></audio>
<audio id="fuelAlert" src="https://freesound.org/data/previews/466/466178_9604726-lq.mp3"></audio>

<div id="layout">

<!-- LEFT PANEL -->
<div id="panel">
 <h2>BC AEROCORPS ‚Äî ATC</h2>
 <button onclick="toggleNightMode()">üåô Night Mode</button>
 <div id="score">Score: 0</div>
 <div id="flights"></div>
 <div id="sectorCounts"></div>
 
 


</div>

<!-- RADAR -->
<div id="radarWrap">
 <svg id="radar"></svg>

 <div class="popup" id="incident">
   <h3>INCIDENT REPORT</h3>
   <p id="incidentText"></p>
   <button onclick="location.reload()">End Shift</button>
 </div>
</div>



</div>

<script>
const radar=document.getElementById("radar");
const W=window.innerWidth-360,H=window.innerHeight;
const SEP=26,MAX=14;
const SPAWN_SAFE_DIST = SEP * 3;

let planes=[],selected=null,run=true;

let score = Number(localStorage.getItem("bc_atc_score")) || 0;
const scoreEl = document.getElementById("score");
updateScoreDisplay();


let audioUnlocked = false;
function unlockAudio() {
  if (audioUnlocked) return;
  const sounds = ["ping", "warnBeep", "fuelAlert"];
  sounds.forEach(id => {
    const audio = document.getElementById(id);
    audio.play().catch(()=>{}); 
    audio.pause();
    audio.currentTime = 0;
  });
  audioUnlocked = true;
}

document.body.addEventListener("click", unlockAudio, {once:true});

let incidentLog = JSON.parse(localStorage.getItem("bc_atc_log")) || [];
const logEl = document.getElementById("incidentLog");

function addToLog(msg){
    const entry = `[${new Date().toLocaleTimeString()}] ${msg}`;
    incidentLog.push(entry);
    localStorage.setItem("bc_atc_log", JSON.stringify(incidentLog));
    const p = document.createElement("div");
    p.textContent = entry;
    logEl.appendChild(p);
    logEl.scrollTop = logEl.scrollHeight;
}

function resetLog(){
    incidentLog = [];
    localStorage.removeItem("bc_atc_log");
    logEl.innerHTML = "";
}


const R=(a,b)=>Math.random()*(b-a)+a;
const D=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
let sweepAngle=0;
let radarZoom=1;


let tiltX = 0; // left/right rotation
let tiltY = 0; // up/down rotation
let dragging = false, lastX = 0, lastY = 0;

radarWrap.addEventListener("mousedown", e => {
    dragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
});
radarWrap.addEventListener("mousemove", e => {
    if (!dragging) return;
    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;
    lastX = e.clientX;
    lastY = e.clientY;

    tiltX += dx * 0.2; // adjust sensitivity
    tiltY += dy * 0.2;
    tiltY = Math.max(-45, Math.min(45, tiltY)); // limit vertical tilt

    // Apply skew/scale to radar to simulate 3D perspective
    radar.setAttribute("transform", `translate(${W/2},${H/2}) rotateX(${tiltY}deg) rotateY(${tiltX}deg) translate(${-W/2},${-H/2})`);
});
radarWrap.addEventListener("mouseup", () => dragging = false);
radarWrap.addEventListener("mouseleave", () => dragging = false);

// Touch events
radarWrap.addEventListener("touchstart", e => {
    dragging = true;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;
});
radarWrap.addEventListener("touchmove", e => {
    if (!dragging) return;
    const dx = e.touches[0].clientX - lastX;
    const dy = e.touches[0].clientY - lastY;
    lastX = e.touches[0].clientX;
    lastY = e.touches[0].clientY;

    tiltX += dx * 0.2;
    tiltY += dy * 0.2;
    tiltY = Math.max(-45, Math.min(45, tiltY));

    radar.setAttribute("transform", `translate(${W/2},${H/2}) rotateX(${tiltY}deg) rotateY(${tiltX}deg) translate(${-W/2},${-H/2})`);
});
radarWrap.addEventListener("touchend", () => dragging = false);

const PLANE_TYPES={
 jet:{speedMul:1.2,burnMul:1.9},
 turboprop:{speedMul:0.9,burnMul:1.4},
 cargo:{speedMul:0.75,burnMul:1.7}
};

radar.setAttribute("viewBox", `0 0 ${W} ${H}`);

const grid=document.createElementNS("http://www.w3.org/2000/svg","g");
for(let i=0;i<W;i+=80){
 let l=document.createElementNS("http://www.w3.org/2000/svg","line");
 l.setAttribute("x1",i);l.setAttribute("y1",0);
 l.setAttribute("x2",i);l.setAttribute("y2",H);grid.appendChild(l)
}
for(let i=0;i<H;i+=80){
 let l=document.createElementNS("http://www.w3.org/2000/svg","line");
 l.setAttribute("x1",0);l.setAttribute("y1",i);
 l.setAttribute("x2",W);l.setAttribute("y2",i);grid.appendChild(l)
}
radar.appendChild(grid);

const weatherZones=[];
function spawnWeather(){
 const z=document.createElementNS("http://www.w3.org/2000/svg","circle");
 const wx=Math.random()*W,wy=Math.random()*H;
 z.setAttribute("cx",wx);z.setAttribute("cy",wy);
 z.setAttribute("r",80);z.classList.add("weather");
 radar.appendChild(z);
 weatherZones.push({x:wx,y:wy,r:80})
}
spawnWeather();

const fuelStations = [];
function spawnFuelStations() {
  for (let i = 0; i < 3; i++) {
    const fx = R(50, W - 50);
    const fy = R(50, H - 50);

    const fSVG = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    fSVG.setAttribute("cx", fx);
    fSVG.setAttribute("cy", fy);
    fSVG.setAttribute("r", 8);
    fSVG.setAttribute("fill", "#ff4d4d");
    radar.appendChild(fSVG);

    fuelStations.push({ x: fx, y: fy, svg: fSVG });
  }
}
spawnFuelStations();


function updateScoreDisplay(){
  scoreEl.textContent = "Score: " + score.toLocaleString();
}


function spawnPlane(){
 if(planes.length>=MAX)return;
 const typeKeys=Object.keys(PLANE_TYPES);
 const type=typeKeys[Math.floor(Math.random()*typeKeys.length)];

let startX, startY;
let attempts = 0;
do {
  startX = R(100, W - 100);
  startY = R(100, H - 100);
  attempts++;
} while (!isSpawnSafe(startX, startY) && attempts < 20);

if (attempts >= 20) return; // abort spawn if no safe space

let destX = startX + (Math.random() < 0.5 ? R(50, 200) : -R(50, 200));
let destY = startY + (Math.random() < 0.5 ? R(50, 200) : -R(50, 200));
destX = Math.min(Math.max(destX, 50), W-50);
destY = Math.min(Math.max(destY, 50), H-50);

const p = {
  id: "BC-" + Math.floor(R(1000,9999)),
  type,
  x: startX,
  y: startY,
  route: [{x: destX, y: destY}],
  speed: R(1.0, .8) * PLANE_TYPES[type].speedMul,
  fuel: 100,
  burnMul: PLANE_TYPES[type].burnMul,
  holding: false,
  runway: false,
  emergency: false,
  distanceFlown: 0,
  lastX: startX,
  lastY: startY,
  scorable: true,
  svg: null,
  path: null,
  label: null,
  angle: Math.random() * 2 * Math.PI,
  curved: Math.random() < 0.15   // <-- 15% chance to be curved
};


 createSVG(p);planes.push(p);addStrip(p)
}

function createSVG(p){
    p.svg = document.createElementNS("http://www.w3.org/2000/svg","text");
    p.svg.textContent = "‚úà";
    p.svg.setAttribute("x", p.x);
    p.svg.setAttribute("y", p.y);
    p.svg.setAttribute("font-size","20");
    p.svg.setAttribute("text-anchor","middle");
    p.svg.setAttribute("dominant-baseline","middle");
    p.svg.setAttribute("class","plane");
    p.svg.setAttribute("fill","#ffffff");
    p.svg.addEventListener("click", (e)=>{ e.stopPropagation(); hold(p.id); });
    radar.appendChild(p.svg);

    p.path = document.createElementNS("http://www.w3.org/2000/svg","path");
    p.path.setAttribute("stroke","#5fa8ff");
    p.path.setAttribute("stroke-width","2");
    p.path.setAttribute("fill","none");
    radar.appendChild(p.path);

    p.label = document.createElementNS("http://www.w3.org/2000/svg","text");
    p.label.textContent = p.id;
    p.label.setAttribute("x", p.x + 15);
    p.label.setAttribute("y", p.y - 10);
    p.label.setAttribute("fill","#ffffff");
    p.label.setAttribute("class","planeLabel");
    radar.appendChild(p.label);

    const distCenter = D(p, {x: W/2, y: H/2});
    const maxDist = Math.hypot(W/2, H/2);
    p.svg.setAttribute("opacity", 1 - (distCenter / maxDist) * 0.7);
    p.label.setAttribute("opacity", 1 - (distCenter / maxDist) * 0.7);

    drawRoute(p);
}

function addStrip(p){
 const d=document.createElement("div");
 d.className="strip";
 d.innerHTML=`<b>${p.id}</b>
 <div class="meta">Fuel: <span class="fuel">${p.fuel.toFixed(0)}</span>%</div>
 <div class="controls">
  <button onclick="hold('${p.id}')">HOLD</button>
  <button onclick="declareEmergency('${p.id}')">EMERG</button>
 </div>`;
 d.onclick=()=>{
  document.querySelectorAll(".strip").forEach(s=>s.classList.remove("active"));
  d.classList.add("active");selected=p
 };
 document.getElementById("flights").appendChild(d);p.strip=d
}

function assignRunway(id){
 const p=planes.find(x=>x.id===id);
 p.route=[{x:W/2,y:H-30}];p.runway=true
}

function hold(id){
  const p = planes.find(x => x.id === id);
  if(!p) return;

  if(p.holding){
      p.holding = false;
      if(p.savedRoute){ p.route = p.savedRoute; p.savedRoute=null; }
      if(p.holdTimeout){ clearTimeout(p.holdTimeout); p.holdTimeout=null; }
  } else {
      p.holding = true;
      p.holdCenter={x:p.x,y:p.y};
      p.holdAngle=0;
      p.holdRadius=R(30,60);
      p.savedRoute = p.route.slice();
      p.route=[];
      
  }

  if(p.strip) p.strip.classList.toggle("active",p.holding);
}

function declareEmergency(id){
  const p = planes.find(x => x.id === id);
  if(!p) return;

  p.emergency = true;
  p.holding = false;

  let closest = fuelStations[0];
  let minDist = D(p, closest);
  for (const station of fuelStations) {
    const dist = D(p, station);
    if (dist < minDist) { minDist = dist; closest = station; }
  }

  p.route = [{ x: closest.x, y: closest.y }];
  p.strip.classList.add("emergency");
}

radar.onclick=e=>{
 if(!selected||!run||selected.holding)return;
 const r=radar.getBoundingClientRect();
 selected.route.push({x:e.clientX-r.left,y:e.clientY-r.top})
};

function removePlane(p) {
  if(p.svg) radar.removeChild(p.svg);
  if(p.path) radar.removeChild(p.path);
  if(p.label) radar.removeChild(p.label);
  if(p.route) p.route.forEach(pt => { if(pt.marker) radar.removeChild(pt.marker); });
  if(p.strip) p.strip.remove();
  const index = planes.indexOf(p);
  if(index !== -1) planes.splice(index, 1);
}


function getCubicBezierPoint(t, p0, p1, p2, p3) {
    const u = 1 - t;
    const tt = t*t;
    const uu = u*u;
    const uuu = uu * u;
    const ttt = tt * t;

    return {
        x: uuu*p0.x + 3*uu*t*p1.x + 3*u*tt*p2.x + ttt*p3.x,
        y: uuu*p0.y + 3*uu*t*p1.y + 3*u*tt*p2.y + ttt*p3.y
    };
}


function drawRoute(p) {
    if (!p.route.length) return;

    let d = `M ${p.x} ${p.y} `;  // Start at plane's current position
    const points = [{ x: p.x, y: p.y }, ...p.route];

    for (let i = 1; i < points.length; i++) {
        const prev = points[i - 1];
        const curr = points[i];

       if(p.emergency) p.path.setAttribute("stroke", "var(--danger)");
else if(p.holding) p.path.setAttribute("stroke", "#6fa8ff"); // holding pattern color
else if(p.curved) p.path.setAttribute("stroke", "#5fa8ff");
else p.path.setAttribute("stroke", "#4cff9f"); // normal

       
       
        if(p.curved){  // <-- only curve sometimes
            const cp1x = prev.x + (curr.x - prev.x) / 2;
            const cp1y = prev.y;
            const cp2x = curr.x - (curr.x - prev.x) / 2;
            const cp2y = curr.y;
            d += `C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${curr.x} ${curr.y} `;
        } else {
            d += `L ${curr.x} ${curr.y} `; // straight line
        }

        if(!curr.marker){
          curr.marker = document.createElementNS("http://www.w3.org/2000/svg","circle");
          curr.marker.setAttribute("cx",curr.x);
          curr.marker.setAttribute("cy",curr.y);
          curr.marker.setAttribute("r",3);
          curr.marker.setAttribute("fill","#5fa8ff");
          radar.appendChild(curr.marker);
        } else {
          curr.marker.setAttribute("cx", curr.x);
          curr.marker.setAttribute("cy", curr.y);
        }
    }

    p.path.setAttribute("d", d);
}


let incidentActive = false;
let lastWarnTime = 0;

function detect(){
  planes.forEach(p => p.path.classList.remove("warn","danger"));
  if(incidentActive) return;
  const flyingPlanes = planes.filter(p => !p.holding && !p.landing);
  const now = performance.now();

  for(let i=0; i<flyingPlanes.length; i++){
    for(let j=i+1; j<flyingPlanes.length; j++){
      const p1 = flyingPlanes[i], p2 = flyingPlanes[j];
      const d = D(p1, p2);

      

      
      if(d < SEP) { 
        incidentActive = true; 
        incident("Mid-air collision detected."); 
        return; 
      }

      else if(d < SEP*1.7){ 
        p1.path.classList.add("warn"); 
        p2.path.classList.add("warn"); 

        if(now - lastWarnTime > 500){
          const beep = document.getElementById("warnBeep");
          beep.currentTime = 0;
          beep.play().catch(()=>{}); 
          lastWarnTime = now;
        }
      }
    }
  }
}

function isSpawnSafe(x, y) {
  return planes.every(p => Math.hypot(p.x - x, p.y - y) > SPAWN_SAFE_DIST);
}


function toggleRun(){
    run = !run;
}


function incident(msg){
  run=false;
  const popup = document.getElementById("incident");
  document.getElementById("incidentText").textContent = msg;
  popup.style.display = "block";
  
  addToLog(msg); // <-- ADD THIS
}

const sweepGroup = document.createElementNS("http://www.w3.org/2000/svg","g");
radar.appendChild(sweepGroup);

let sweepLines = [];

function updateSweep(){
    const length = Math.max(W,H);
    const x2 = W/2 + Math.cos(sweepAngle) * length;
    const y2 = H/2 + Math.sin(sweepAngle) * length;

    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1", W/2);
    line.setAttribute("y1", H/2);
    line.setAttribute("x2", x2);
    line.setAttribute("y2", y2);
    line.setAttribute("stroke", "var(--accent)");
    line.setAttribute("stroke-width", 2);
    line.setAttribute("opacity", 0.6);
    sweepGroup.appendChild(line);
    sweepLines.push(line);
if(sweepLines.length > 30){
  const old = sweepLines.shift();
  sweepGroup.removeChild(old);
}

    // fade out old lines
    sweepLines.forEach(l=>{
        let o = parseFloat(l.getAttribute("opacity"));
        l.setAttribute("opacity", o*0.95);
        if(o*0.95<0.05){
            sweepGroup.removeChild(l);
        }
    });
}

let windX = 0.1;
let windY = 0;

let lastTime = performance.now();
function update(time){
    const dt = (time - lastTime) / 1000;
    lastTime = time;

   sweepAngle += 0.02;
updateSweep();

   
   
    if(!run){ requestAnimationFrame(update); return;}
    sweepAngle += 0.02;
    const length=Math.max(W,H);
   
    
    planes.forEach(p=>{
    if(p.landing) return;
    if(p.holding) return;

    if(p.route.length){
        const t=p.route[0];
        const dx=t.x-p.x, dy=t.y-p.y;
        const d=Math.hypot(dx,dy);

        if(d < 2){ 
            p.route.shift(); 
            if(p.route.length === 0){

    if(p.scorable){
        let basePoints = Math.floor(p.distanceFlown);

        if(p.emergency) basePoints = Math.floor(basePoints * 0.5);

        score += basePoints;
        localStorage.setItem("bc_atc_score", score);
        updateScoreDisplay();
    }

                if(p.svg){ p.svg.style.transition = "opacity 0.5s"; p.svg.style.opacity = 0; }
                if(p.label){ p.label.style.transition = "opacity 0.5s"; p.label.style.opacity = 0; }
                if(p.path){ p.path.style.transition = "opacity 0.5s"; p.path.style.opacity = 0; }
                p.route.forEach(pt => { if(pt.marker){ pt.marker.style.transition="opacity 0.5s"; pt.marker.style.opacity=0; }});
                spawnPlane();
                setTimeout(() => removePlane(p), 500);
            }
        }

        if(!p.landing && !p.holding){ p.fuel -= p.speed*p.burnMul*dt*1.5; if(p.fuel<0) p.fuel=0; }

        const windCircle = { x: W/2, y: H/2, r: 100 };
        const distToCircle = Math.hypot(p.x - windCircle.x, p.y - windCircle.y);
        let speedFactor = distToCircle <= windCircle.r ? 0.4 : 1;

        let avoidX = 0, avoidY = 0;
        const avoidDist = Math.hypot(avoidX, avoidY);
        if(avoidDist > 0){ avoidX /= avoidDist; avoidY /= avoidDist; }
        p.x += (dx/d + avoidX) * p.speed * 0.7 * speedFactor;
        p.y += (dy/d + avoidY) * p.speed * 0.7 * speedFactor;
        p.x += windX * p.speed * 0.1 * speedFactor;
        p.y += windY * p.speed * 0.1 * speedFactor;

        const fuelSpan=p.strip.querySelector(".fuel");
        fuelSpan.textContent=p.fuel.toFixed(0);
        p.strip.classList.toggle("warnFuel", p.fuel<30);
        p.strip.classList.toggle("dangerFuel", p.fuel<10);
        if(p.fuel<=0){
  p.scorable = false;
  incident("Fuel exhaustion ‚Äî emergency loss.");
}

        p.svg.setAttribute("x",p.x);
        p.svg.setAttribute("y",p.y);
        p.label.setAttribute("x",p.x+15);
        p.label.setAttribute("y",p.y-10);
        drawRoute(p);
    }
    
    const dxMove = p.x - p.lastX;
const dyMove = p.y - p.lastY;
p.distanceFlown += Math.hypot(dxMove, dyMove);
p.lastX = p.x;
p.lastY = p.y;


    if(p.emergency && p.route.length===0){
        p.fuel=Math.min(p.fuel+25,100);
        p.emergency=false;
        p.strip.classList.remove("emergency");
        p.route.push({x:R(100,W-100),y:R(100,H-100)});
    }

    });

    detect();
    requestAnimationFrame(update);
}
requestAnimationFrame(update);

radar.addEventListener("wheel", e=>{
  e.preventDefault();
  radarZoom += e.deltaY*-0.001;
  radarZoom=Math.max(0.6,Math.min(2,radarZoom));
  radar.setAttribute("viewBox", `${(W-W/radarZoom)/2} ${(H-H/radarZoom)/2} ${W/radarZoom} ${H/radarZoom}`);
});

function toggleNightMode(){ document.body.classList.toggle("night"); }

for(let i=0;i<1;i++) spawnPlane();
setInterval(spawnPlane,5000);
</script>
</body>
</html>
